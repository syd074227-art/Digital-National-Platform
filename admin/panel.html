<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>بوابة الإدارة | هيئة KR الرقمية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --gold: #b8860b; --primary: #1e3a8a; --bg: #05050a; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; }
        
        .sidebar { width: 280px; background: rgba(255,255,255,0.02); border-left: 1px solid rgba(184,134,11,0.2); padding: 30px; }
        .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #888; transition: 0.3s; margin-bottom: 5px; }
        .nav-item.active { background: var(--primary); color: white; border: 1px solid var(--gold); }
        
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .card { background: rgba(255,255,255,0.03); padding: 25px; border-radius: 20px; border-bottom: 3px solid var(--gold); text-align: center; }
        .card h2 { font-size: 32px; color: var(--gold); margin: 10px 0; }
        
        table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.02); border-radius: 15px; overflow: hidden; }
        th { background: var(--primary); padding: 18px; color: var(--gold); text-align: right; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .btn-ok { background: #059669; color: white; padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; }
        .btn-no { background: #dc2626; color: white; padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; }
        
        #notify-badge { background: red; color: white; padding: 2px 7px; border-radius: 50%; font-size: 11px; margin-right: auto; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="text-align:center; margin-bottom:40px;">
            <i class="fas fa-shield-alt" style="font-size:40px; color:var(--gold);"></i>
            <h3 style="margin-top:10px;">نظام الرقابة</h3>
        </div>
        <div class="nav-item active" onclick="show('h')"><i class="fas fa-chart-line"></i> الإحصائيات</div>
        <div class="nav-item" onclick="show('r')">
            <i class="fas fa-id-card"></i> طلبات التفعيل 
            <span id="notify-badge" style="display:none">0</span>
        </div>
        <div class="nav-item" onclick="show('b')"><i class="fas fa-user-slash"></i> المحظورين</div>
    </div>

    <div class="main">
        <div id="h-sec">
            <h1>ملخص النظام اللحظي</h1>
            <div class="stats">
                <div class="card"><h4>طلبات بانتظارك</h4><h2 id="s-pending">0</h2></div>
                <div class="card"><h4>إجمالي المفعلين</h4><h2 id="s-active">0</h2></div>
                <div class="card"><h4>قائمة الحظر</h4><h2 id="s-banned">0</h2></div>
            </div>
        </div>

        <div id="r-sec" style="display:none">
            <h1>طلبات التفعيل الواردة</h1>
            <table>
                <thead><tr><th>رقم الطلب</th><th>الاسم الكامل</th><th>الهوية (ID)</th><th>القطاع والمنصب</th><th>الإجراء</th></tr></thead>
                <tbody id="reqBody"></tbody>
            </table>
        </div>
        
        <div id="b-sec" style="display:none">
            <h1>إدارة المحظورين</h1>
            <table>
                <thead><tr><th>الهوية (ID)</th><th>سبب الحظر</th><th>التاريخ</th><th>الإجراء</th></tr></thead>
                <tbody id="banBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        function show(sec) {
            ['h-sec', 'r-sec', 'b-sec'].forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(sec + '-sec').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            updateData();
        }

        function updateData() {
            const apps = JSON.parse(localStorage.getItem('user_applications') || '[]');
            const bans = JSON.parse(localStorage.getItem('admin_bans') || '[]');
            
            const pending = apps.filter(a => a.status === 'pending');
            const activeCount = apps.filter(a => a.status === 'approved').length;

            // تحديث الأرقام
            document.getElementById('s-pending').innerText = pending.length;
            document.getElementById('s-active').innerText = activeCount;
            document.getElementById('s-banned').innerText = bans.length;
            
            const badge = document.getElementById('notify-badge');
            if(pending.length > 0) { badge.innerText = pending.length; badge.style.display = 'block'; }
            else { badge.style.display = 'none'; }

            // جدول الطلبات
            const rb = document.getElementById('reqBody'); rb.innerHTML = '';
            pending.forEach(a => {
                rb.innerHTML += `<tr>
                    <td>${a.id}</td>
                    <td>${a.name}</td>
                    <td>#${a.gameId}</td>
                    <td>${a.jobName}</td>
                    <td>
                        <button class="btn-ok" onclick="action('${a.id}', 'approved')">تفعيل</button>
                        <button class="btn-no" onclick="banUser('${a.gameId}')">حظر</button>
                    </td>
                </tr>`;
            });

            // جدول الحظر
            const bb = document.getElementById('banBody'); bb.innerHTML = '';
            bans.forEach((b, i) => {
                bb.innerHTML += `<tr><td>#${b.id}</td><td>${b.reason}</td><td>${b.date}</td>
                <td><button class="btn-ok" onclick="unban(${i})">فك الحظر</button></td></tr>`;
            });
        }

        function action(id, status) {
            let apps = JSON.parse(localStorage.getItem('user_applications') || '[]');
            const i = apps.findIndex(a => a.id === id);
            if(i !== -1) {
                apps[i].status = status;
                localStorage.setItem('user_applications', JSON.stringify(apps));
                updateData();
            }
        }

        function banUser(gameId) {
            const reason = prompt("سبب الحظر:");
            if(!reason) return;
            let bans = JSON.parse(localStorage.getItem('admin_bans') || '[]');
            let apps = JSON.parse(localStorage.getItem('user_applications') || '[]');
            
            bans.push({ id: gameId, reason: reason, date: new Date().toLocaleDateString('ar-SA') });
            apps = apps.filter(a => a.gameId !== gameId); // حذف الطلبات المتعلقة به
            
            localStorage.setItem('admin_bans', JSON.stringify(bans));
            localStorage.setItem('user_applications', JSON.stringify(apps));
            updateData();
        }

        function unban(index) {
            let bans = JSON.parse(localStorage.getItem('admin_bans') || '[]');
            bans.splice(index, 1);
            localStorage.setItem('admin_bans', JSON.stringify(bans));
            updateData();
        }

        // تحديث آلي كل 5 ثوانٍ لجلب الطلبات الجديدة فوراً
        setInterval(updateData, 5000);
        window.onload = updateData;
    </script>
</body>
</html>
